{% extends "base_user.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Cart{% endblock %}

{% block link %}
{% endblock %}

{% block style %}
<style>
    .cart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .cart-title {
        font-size: 24px;
        font-weight: bold;
    }
    .cart-content {
        display: flex;
        gap: 20px;
    }
    .cart-items {
        flex: 1;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .cart-item {
        display: flex;
        border-bottom: 1px solid #eee;
        padding: 20px 0;
    }
    .cart-item:last-child {
        border-bottom: none;
    }
    .item-image {
        width: 100px;
        height: 100px;
        object-fit: cover;
        margin-right: 20px;
    }
    .item-details {
        flex: 1;
    }
    .item-name {
        font-weight: bold;
        margin-bottom: 5px;
    }
    .item-meta {
        font-size: 14px;
        color: #666;
        margin-bottom: 5px;
    }
    .item-price {
        font-weight: bold;
    }
    .quantity-select {
        width: 60px;
        padding: 5px;
        margin-right: 10px;
    }
    .remove-item {
        background: none;
        border: none;
        color: #999;
        cursor: pointer;
    }
    .order-summary {
        width: 300px;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .summary-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
    }
    .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    .summary-total {
        font-weight: bold;
        border-top: 1px solid #eee;
        padding-top: 10px;
        margin-top: 10px;
    }
    .checkout-btn {
        display: block;
        width: 100%;
        padding: 10px;
        background-color: #000;
        color: #fff;
        text-align: center;
        text-decoration: none;
        border-radius: 4px;
        margin-top: 20px;
    }
    .empty-cart {
        text-align: center;
        padding: 150px 0;
    }
    .empty-cart h2 {
        font-size: 24px;
        margin-bottom: 10px;
    }
    .empty-cart p {
        font-size: 18px;
        color: #666;
    }
    .latest-products {
        margin-top: 40px;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .latest-products-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .latest-products-title {
        font-size: 24px;
        font-weight: bold;
    }
    .view-all {
        color: #666;
        text-decoration: none;
    }
    .products-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 20px;
    }
    .product-card {
        text-decoration: none;
        color: inherit;
    }
    .product-image {
        width: 100%;
        aspect-ratio: 1;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 10px;
    }
    .product-name {
        font-weight: 500;
        margin-bottom: 5px;
    }
    .product-rating {
        color: #ffd700;
        margin-bottom: 5px;
    }
    .product-price {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .original-price {
        text-decoration: line-through;
        color: #666;
    }
    .sale-price {
        color: #dc3545;
        margin-left: 0.5rem;
    }
</style>
{% endblock %}

{% block body %}
<div class="container">
    {% if cart.items.all %}
    <div class="cart-header">
        <h1 class="cart-title">Shopping Cart</h1>
    </div>
    
    <div class="cart-content">
        <div class="cart-items">
            {% for item in cart.items.all %}
            <div class="cart-item">
                <img src="{{ item.product.images.first.image }}" alt="{{ item.product.name }}" class="item-image">
                <div class="item-details">
                    <div class="item-name">{{ item.product.name }}</div>
                    <div class="item-meta">
                        <div>Color: {{ item.variant.color }}</div>
                        <div>Size: {{ item.variant.size }}</div>
                        <div>
                            {% if item.product.quantity > 0 %}
                                <span style="color: green;">In Stock</span>
                            {% else %}
                                <span style="color: red;">Out of Stock</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="item-price">₹{{ item.price }}</div>
                </div>
                <form method="POST" action="{% url 'update_cart_item' item.id %}" class="quantity-form">
                    {% csrf_token %}
                    <select name="quantity" class="quantity-select" onchange="this.form.submit()"
                        {% if item.product.quantity == 0 %}disabled{% endif %}>
                        {% with max_quantity=item.product.quantity|default:5 %}
                            {% with display_max=max_quantity|min_value:5 %}
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= display_max %}
                                        <option value="{{ forloop.counter }}" 
                                            {% if item.quantity == forloop.counter %}selected{% endif %}>
                                            {{ forloop.counter }}
                                        </option>
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                        {% endwith %}
                    </select>
                </form>
                <form method="POST" action="{% url 'remove_from_cart' item.id %}">
                    {% csrf_token %}
                    <button type="submit" class="remove-item">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>
        <div class="order-summary">
            <h2 class="summary-title">ORDER SUMMARY</h2>
            <div class="summary-item">
                <span>{{ cart.items.count }} ITEMS</span>
                <span>₹{{ cart.total_price }}</span>
            </div>
            <div class="summary-item">
                <span>Delivery Charges</span>
                {% if cart.total_price > 4999 %}
                    <span style="color: green;">Free</span>
                {% else %}
                    <span>₹99</span>
                {% endif %}
            </div>
            {% if total_discount > 0 %}
            <div class="summary-item">
                <span>Discount</span>
                <span>₹{{ total_discount }}</span>
            </div>
            {% endif %}
            <div class="summary-item summary-total">
                <span>TOTAL</span>
                <span>₹{{ cart.total_price }}</span>
            </div>
            <a href="#" class="checkout-btn">Checkout</a>
        </div>
    </div>
    <!-- Latest Products Section -->
    <div class="latest-products">
        <div class="latest-products-header">
            <h2 class="latest-products-title">Latest Products</h2>
            <a href="#" class="view-all">View All</a>
        </div>
        <div class="products-grid">
            {% for product in latest_products %}
            <a href="{% url 'product_detail' product.id %}" class="product-card">
                <img src="{{ product.images.first.image }}" alt="{{ product.name }}" class="product-image">
                <div class="product-name">{{ product.name|truncatechars:15 }}</div>
                <div class="product-rating">
                    {% for i in "12345"|make_list %}
                        {% if forloop.counter <= product.rating %}
                            ★
                        {% else %}
                            ☆
                        {% endif %}
                    {% endfor %}
                    ({{ product.rating }}.0)
                </div>
                <div class="product-price">
                    {% with variant=product.variants.first %}
                    <div class="product-price">
                        <span class="original-price">₹{{ variant.actual_price }}</span>
                        <span class="sale-price">₹{{ variant.sale_price }}</span>
                    </div>
                    {% endwith %}
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="empty-cart">
        <h2>Your cart is empty</h2>
        <p>Add items to your cart to see them here.</p>
    </div>

    <!-- Latest Products Section -->
    <div class="latest-products">
        <div class="latest-products-header">
            <h2 class="latest-products-title">Latest Products</h2>
            <a href="#" class="view-all">View All</a>
        </div>
        <div class="products-grid">
            {% for product in latest_products %}
            <a href="{% url 'product_detail' product.id %}" class="product-card">
                <img src="{{ product.images.first.image }}" alt="{{ product.name }}" class="product-image">
                <div class="product-name">{{ product.name|truncatechars:15 }}</div>
                <div class="product-rating">
                    {% for i in "12345"|make_list %}
                        {% if forloop.counter <= product.rating %}
                            ★
                        {% else %}
                            ☆
                        {% endif %}
                    {% endfor %}
                    ({{ product.rating }}.0)
                </div>
                <div class="product-price">
                    {% with variant=product.variants.first %}
                    <div class="product-price">
                        <span class="original-price">₹{{ variant.actual_price }}</span>
                        <span class="sale-price">₹{{ variant.sale_price }}</span>
                    </div>
                    {% endwith %}
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}
