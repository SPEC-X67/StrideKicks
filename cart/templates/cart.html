{% extends "base_user.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Cart{% endblock %}

{% block link %}
{% endblock %}

{% block style %}
<style>
    .cart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .cart-title {
        font-size: 24px;
        font-weight: bold;
    }
    .cart-content {
        display: flex;
        gap: 20px;
    }
    .cart-items {
        flex: 1;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .cart-item {
        display: flex;
        border-bottom: 1px solid #eee;
        padding: 20px 0;
    }
    .cart-item:last-child {
        border-bottom: none;
    }
    .item-image {
        width: 100px;
        height: 100px;
        object-fit: cover;
        margin-right: 20px;
    }
    .item-details {
        flex: 1;
    }
    .item-meta {
        font-size: 14px;
        color: #666;
        margin-bottom: 5px;
    }
    .item-price {
        font-weight: bold;
    }
    .quantity-select {
        width: 60px;
        padding: 5px;
        margin-right: 10px;
    }
    .remove-item {
        background: none;
        border: none;
        color: #999;
        cursor: pointer;
    }
    .order-summary {
        width: 300px;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .summary-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
    }
    .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    .summary-total {
        font-weight: bold;
        border-top: 1px solid #eee;
        padding-top: 10px;
        margin-top: 10px;
    }
    .checkout-btn {
        display: block;
        width: 100%;
        padding: 10px;
        background-color: #000;
        color: #fff;
        text-align: center;
        text-decoration: none;
        border-radius: 4px;
        margin-top: 20px;
    }
    .empty-cart {
        text-align: center;
        padding: 150px 0;
    }
    .empty-cart h2 {
        font-size: 24px;
        margin-bottom: 10px;
    }
    .empty-cart p {
        font-size: 18px;
        color: #666;
    }
    .latest-products {
        margin-top: 40px;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .latest-products-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .latest-products-title {
        font-size: 24px;
        font-weight: bold;
    }
    .view-all {
        color: #666;
        text-decoration: none;
    }
    .products-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 20px;
    }
    .product-card {
        text-decoration: none;
        color: inherit;
    }
    .product-image {
        width: 100%;
        aspect-ratio: 1;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 10px;
    }
    .product-name {
        font-weight: 500;
        margin-bottom: 5px;
    }
    .product-rating {
        color: #ffd700;
        margin-bottom: 5px;
    }
    .product-price {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .original-price {
        text-decoration: line-through;
        color: #666;
    }
    .sale-price {
        color: #dc3545;
        margin-left: 0.5rem;
    }
    .coupon-section {
        margin-bottom: 20px;
    }
    .coupon-form {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }
    .coupon-input {
        flex-grow: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .coupon-button {
        padding: 8px 16px;
        background-color: #fff;
        color: #ff6b6b;
        border: 1px solid #ffffff;
        border-radius: 4px;
        cursor: pointer;
    }

    .coupon-list-button {
        background: none;
        border: none;
        color: #007bff;
        text-decoration: underline;
        cursor: pointer;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
    }
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block body %}
<div class="container">
    {% if cart.items.all %}
    <div class="cart-header">
        <h1 class="cart-title">Shopping Cart</h1>
    </div>
    
    <div class="cart-content">
        <div class="cart-items">
            {% for item in cart.items.all %}
            <div class="cart-item">
                <a href="{% url 'product_detail' item.product.id %}">
                    <img src="{{ item.product.images.first.image }}" alt="{{ item.product.name }}" class="item-image">
                </a>
                <div class="item-details">
                    <a href="{% url 'product_detail' item.product.id %}" class="text-decoration-none text-dark">
                        <div class="fw-bold">{{ item.product.name }}</div>
                    </a>
                    <div class="item-meta">
                        <div>Color: {{ item.variant.color }}</div>
                        <div>Size: {{ item.variant.size }}</div>
                        <div>
                            {% if item.product.total_quantity > 0 %}
                                <span style="color: green;">In Stock</span>
                            {% else %}
                                <span style="color: red;">Out of Stock</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="item-price">₹{{ item.price }}</div>
                </div>
                <form method="POST" action="{% url 'update_cart_item' item.id %}" class="quantity-form">
                    {% csrf_token %}
                    <select name="quantity" class="quantity-select" onchange="this.form.submit()"
                        {% if item.product.quantity == 0 %}disabled{% endif %}>
                        {% with max_quantity=item.product.quantity|default:5 %}
                            {% with display_max=max_quantity|min_value:5 %}
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= display_max %}
                                        <option value="{{ forloop.counter }}" 
                                            {% if item.quantity == forloop.counter %}selected{% endif %}>
                                            {{ forloop.counter }}
                                        </option>
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                        {% endwith %}
                    </select>
                </form>
                <form method="POST" action="{% url 'remove_from_cart' item.id %}">
                    {% csrf_token %}
                    <button type="submit" class="remove-item">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>
        <div class="order-summary">
            <div class="coupon-section">
                {% if not coupon_code %}
                <form id="couponForm" class="coupon-form">
                    {% csrf_token %}
                    <input type="text" class="coupon-input" id="couponCode" name="coupon_code" placeholder="Enter coupon code">
                    <button class="coupon-button" type="submit">Apply</button>
                </form>
                <button id="couponListButton" class="coupon-list-button">View available coupons</button>
                {% else %}
                <div>
                    <span>Applied Coupon: <strong>{{ coupon_code.code }}</strong></span>
                    <button id="removeCouponButton" class="coupon-button">Remove Coupon</button>
                </div>
                {% endif %}
            </div>
            <h2 class="summary-title">ORDER SUMMARY</h2>
            <div class="summary-item">
                <span>{{ cart.items.count }} ITEMS</span>
                <span>₹{{ total_actual_price }}</span>
            </div>
            <div class="summary-item">
                <span>Delivery Charges</span>
                {% if cart.total_price > 4999 %}
                    <span style="color: green;">Free</span>
                {% else %}
                    <span>₹99</span>
                {% endif %}
            </div>
            <div class="summary-item">
                <span>Saved</span>
                <span>₹{{ total_discount }}</span>
            </div>
            {% if discount_amount > 0 %}
            <div class="summary-item">
                <span>Coupon Applied</span>
                <span>₹ {{ discount_amount }}</span>
            </div>
            <div class="summary-item summary-total">
                <span>TOTAL</span>
                <span>₹{{ total_price_after_coupon_discount }}</span>
            </div>
            {% else %}
            <div class="summary-item">
                <span>Coupon Applied</span>
                <span>₹ 0</span>
            </div>
            <div class="summary-item summary-total">
                <span>TOTAL</span>
                <span>₹{{ total_price_after_coupon_discount }}</span>
            </div>
            {% endif %}
            <a href="{% url 'checkout' %}" class="checkout-btn">Checkout</a>
        </div>
    </div>
    <!-- Latest Products Section -->
    <div class="latest-products">
        <div class="latest-products-header">
            <h2 class="latest-products-title">Latest Products</h2>
            <a href="{% url 'product_listing' %}" class="view-all">View All</a>
        </div>
        <div class="products-grid">
            {% for product in latest_products %}
            <a href="{% url 'product_detail' product.id %}" class="product-card">
                <img src="{{ product.images.first.image }}" alt="{{ product.name }}" class="product-image">
                <div class="product-name">{{ product.name|truncatechars:15 }}</div>
                <div class="product-rating">
                    {% for i in "12345"|make_list %}
                        {% if forloop.counter <= product.rating %}
                            ★
                        {% else %}
                            ☆
                        {% endif %}
                    {% endfor %}
                    ({{ product.rating }}.0)
                </div>
                <div class="product-price">
                    {% with variant=product.variants.first %}
                    <div class="product-price">
                        <span class="original-price">₹{{ variant.actual_price }}</span>
                        <span class="sale-price">₹{{ variant.sale_price }}</span>
                    </div>
                    {% endwith %}
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    <div id="couponModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Available Coupons</h2>
            <div id="couponList"></div>
        </div>
    </div>
    {% else %}
    <div class="empty-cart">
        <h2>Your cart is empty</h2>
        <p>Add items to your cart to see them here.</p>
    </div>

    <!-- Latest Products Section -->
    <div class="latest-products">
        <div class="latest-products-header">
            <h2 class="latest-products-title">Latest Products</h2>
            <a href="{% url 'product_listing' %}" class="view-all">View All</a>
        </div>
        <div class="products-grid">
            {% for product in latest_products %}
            <a href="{% url 'product_detail' product.id %}" class="product-card">
                <img src="{{ product.images.first.image }}" alt="{{ product.name }}" class="product-image">
                <div class="product-name">{{ product.name|truncatechars:15 }}</div>
                <div class="product-rating">
                    {% for i in "12345"|make_list %}
                        {% if forloop.counter <= product.rating %}
                            ★
                        {% else %}
                            ☆
                        {% endif %}
                    {% endfor %}
                    ({{ product.rating }}.0)
                </div>
                <div class="product-price">
                    {% with variant=product.variants.first %}
                    <div class="product-price">
                        <span class="original-price">₹{{ variant.actual_price }}</span>
                        <span class="sale-price">₹{{ variant.sale_price }}</span>
                    </div>
                    {% endwith %}
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const couponForm = document.getElementById('couponForm');
        const couponListButton = document.getElementById('couponListButton');
        const couponModal = document.getElementById('couponModal');
        const closeModal = document.querySelector('.close');
        const removeCouponButton = document.getElementById('removeCouponButton');
    
        if (couponForm) {
            couponForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const couponCode = document.getElementById('couponCode').value;
                applyCoupon(couponCode);
            });
        }
    
        if (couponListButton) {
            couponListButton.addEventListener('click', function() {
                fetchAvailableCoupons();
                couponModal.style.display = "block";
            });
        }
    
        if (closeModal) {
            closeModal.addEventListener('click', function() {
                couponModal.style.display = "none";
            });
        }
    
        if (removeCouponButton) {
            removeCouponButton.addEventListener('click', function() {
                removeCoupon();
            });
        }
    
        window.addEventListener('click', function(event) {
            if (event.target == couponModal) {
                couponModal.style.display = "none";
            }
        });
    
        function applyCoupon(couponCode) {
            fetch(`/cart/apply-coupon/${couponCode}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Coupon applied successfully!', 'success');
                    updateOrderSummary(data);
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('An error occurred while applying the coupon. Please try again.', 'error');
            });
        }
    
        function fetchAvailableCoupons() {
            fetch('/cart/available-coupons/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            })
            .then(response => response.json())
            .then(data => {
                const couponList = document.getElementById('couponList');
                couponList.innerHTML = '';
                data.coupons.forEach(coupon => {
                    const couponElement = document.createElement('div');
                    couponElement.textContent = `${coupon.code} - ${coupon.description}`;
                    couponElement.style.cursor = 'pointer';
                    couponElement.addEventListener('click', function() {
                        applyCoupon(coupon.code);
                        couponModal.style.display = "none";
                    });
                    couponList.appendChild(couponElement);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('An error occurred while fetching available coupons.', 'error');
            });
        }
    
        function removeCoupon() {
            fetch('/cart/remove-coupon/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Coupon removed successfully', 'success');
                    location.reload();
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('An error occurred while removing the coupon. Please try again.', 'error');
            });
        }
    
        function updateOrderSummary(data) {
            document.querySelector('.summary-total span:last-child').textContent = `₹${data.new_total}`;
            const summaryItems = document.querySelector('.order-summary');
            const existingCouponItem = summaryItems.querySelector('.summary-item:nth-last-child(2)');
            if (existingCouponItem && existingCouponItem.textContent.includes('Coupon Applied')) {
                existingCouponItem.querySelector('span:last-child').textContent = `-₹${data.discount_amount}`;
            } else {
                const couponItem = document.createElement('div');
                couponItem.className = 'summary-item';
                couponItem.innerHTML = `<span>Coupon Applied</span><span>-₹${data.discount_amount}</span>`;
                summaryItems.insertBefore(couponItem, summaryItems.querySelector('.summary-total'));
            }
            location.reload();
        }
    
        function showMessage(message, type) {
            const popup = document.createElement('div');
            popup.className = `popup ${type}`;
            popup.textContent = message;
            document.body.appendChild(popup);
            popup.classList.add('show');
            setTimeout(() => {
                popup.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(popup);
                }, 300);
            }, 5000);
        }
    });
</script>
{% endblock %}
