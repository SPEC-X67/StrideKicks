{% extends "base_user.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Cart{% endblock %}

{% block link %}
<link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% endblock %}

{% block style %}
{% endblock %}

{% block body %}
<div class="container">
    {% if cart.items.all %}
    <div class="cart-header">
        <h1 class="cart-title">Shopping Cart</h1>
    </div>
    
    <div class="cart-content">
        <div class="cart-items">
            {% for item in cart_items %}
            <div class="cart-item">
                <a href="{% url 'product_detail' item.product.id %}">
                    <img src="{{ item.product.images.first.image }}" alt="{{ item.product.name }}" class="item-image">
                </a>
                <div class="item-details">
                    <a href="{% url 'product_detail' item.product.id %}" class="text-decoration-none text-dark">
                        <div class="fw-bold">{{ item.product.name }}</div>
                    </a>
                    <div class="item-meta">
                        <div>Color: {{ item.variant.color }}</div>
                        <div>Size: {{ item.variant.size }}</div>
                        <div>
                            {% if item.in_stock > 0 %}
                                <span style="color: green;">In Stock</span>
                            {% else %}
                                <span style="color: red;">Out of Stock</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="item-price">₹{{ item.price }}</div>
                </div>
                <form method="POST" action="{% url 'update_cart_item' item.id %}" class="quantity-form">
                    {% csrf_token %}
                    <select name="quantity" class="quantity-select" onchange="this.form.submit()"
                        {% if item.product.quantity == 0 %}disabled{% endif %}>
                        {% with max_quantity=item.product.quantity|default:5 %}
                            {% with display_max=max_quantity|min_value:5 %}
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= display_max %}
                                        <option value="{{ forloop.counter }}" 
                                            {% if item.quantity == forloop.counter %}selected{% endif %}>
                                            {{ forloop.counter }}
                                        </option>
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                        {% endwith %}
                    </select>
                </form>
                <form method="POST" action="{% url 'remove_from_cart' item.id %}">
                    {% csrf_token %}
                    <button type="submit" class="remove-item">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>
        <div class="order-summary">
            <div class="coupon-section">
                {% if not coupon_code %}
                <form id="couponForm" class="coupon-form">
                    {% csrf_token %}
                    <input type="text" class="coupon-input" id="couponCode" name="coupon_code" placeholder="Enter coupon code">
                    <button class="coupon-button" type="submit">Apply</button>
                </form>
                <button id="couponListButton" class="coupon-list-button">View available coupons</button>
                <div id="couponResult" class="coupon-result"></div>
                {% else %}
                <div>
                    <span>Applied Coupon: <strong>{{ coupon_code.code }}</strong></span>
                    <button id="removeCouponButton" class="coupon-button">Remove Coupon</button>
                </div>
                {% endif %}
            </div>
            <h2 class="summary-title">ORDER SUMMARY</h2>
            <div class="summary-item">
                <span>{{ cart.items.count }} ITEMS</span>
                <span>₹{{ total_actual_price }}</span>
            </div>
            <div class="summary-item">
                <span>Delivery Charges</span>
                {% if cart.total_price > 4999 %}
                    <span style="color: green;">Free</span>
                {% else %}
                    <span>₹99</span>
                {% endif %}
            </div>
            <div class="summary-item">
                <span>Saved</span>
                <span>₹{{ total_discount }}</span>
            </div>
            {% if discount_amount > 0 %}
            <div class="summary-item">
                <span>Coupon Applied</span>
                <span>₹ {{ discount_amount }}</span>
            </div>
            <div class="summary-item summary-total">
                <span>TOTAL</span>
                <span>₹{{ total_price_after_coupon_discount }}</span>
            </div>
            {% else %}
            <div class="summary-item">
                <span>Coupon Applied</span>
                <span>₹ 0</span>
            </div>
            <div class="summary-item summary-total">
                <span>TOTAL</span>
                <span>₹{{ total_price_after_coupon_discount }}</span>
            </div>
            {% endif %}
            <a href="{% url 'checkout' %}" class="checkout-btn">Checkout</a>
        </div>
    </div>
    <!-- Latest Products Section -->
    <div class="latest-products">
        <div class="latest-products-header">
            <h2 class="latest-products-title">Latest Products</h2>
            <a href="{% url 'product_listing' %}" class="view-all">View All</a>
        </div>
        <div class="products-grid">
            {% for product in latest_products %}
            <a href="{% url 'product_detail' product.id %}" class="product-card">
                <img src="{{ product.images.first.image }}" alt="{{ product.name }}" class="product-image">
                <div class="product-name">{{ product.name|truncatechars:15 }}</div>
                <div class="product-rating">
                    {% for i in "12345"|make_list %}
                        {% if forloop.counter <= product.rating %}
                            ★
                        {% else %}
                            ☆
                        {% endif %}
                    {% endfor %}
                    ({{ product.rating }}.0)
                </div>
                <div class="product-price">
                    {% with variant=product.variants.first %}
                    <div class="product-price">
                        <span class="original-price">₹{{ variant.actual_price }}</span>
                        <span class="sale-price">₹{{ variant.sale_price }}</span>
                    </div>
                    {% endwith %}
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    <div id="couponModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Available Coupons</h2>
            <div id="couponList"></div>
        </div>
    </div>
    {% else %}
    <div class="empty-cart">
        <h2>Your cart is empty</h2>
        <p>Add items to your cart to see them here.</p>
        <h5 style="text-align: center;">
            <a class="button-link bold-text" href="{% url 'product_listing' %}" style="display: inline-block; padding: 10px 20px; text-decoration: none; border-radius: 5px; color: rgb(51, 50, 50);">
                Shop Now
            </a>
        </h5>        
    </div>

    <!-- Latest Products Section -->
    <div class="latest-products">
        <div class="latest-products-header">
            <h2 class="latest-products-title">Latest Products</h2>
            <a href="{% url 'product_listing' %}" class="view-all">View All</a>
        </div>
        <div class="products-grid">
            {% for product in latest_products %}
            <a href="{% url 'product_detail' product.id %}" class="product-card">
                <img src="{{ product.images.first.image }}" alt="{{ product.name }}" class="product-image">
                <div class="product-name">{{ product.name|truncatechars:15 }}</div>
                <div class="product-rating">
                    {% for i in "12345"|make_list %}
                        {% if forloop.counter <= product.rating %}
                            ★
                        {% else %}
                            ☆
                        {% endif %}
                    {% endfor %}
                    ({{ product.rating }}.0)
                </div>
                <div class="product-price">
                    {% with variant=product.variants.first %}
                    <div class="product-price">
                        <span class="original-price">₹{{ variant.actual_price }}</span>
                        <span class="sale-price">₹{{ variant.sale_price }}</span>
                    </div>
                    {% endwith %}
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const couponForm = document.getElementById('couponForm');
        const couponListButton = document.getElementById('couponListButton');
        const couponModal = document.getElementById('couponModal');
        const closeModal = document.querySelector('.close');
        const removeCouponButton = document.getElementById('removeCouponButton');
    
        if (couponForm) {
            couponForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const couponCode = document.getElementById('couponCode').value;
                applyCoupon(couponCode);
            });
        }

        if (couponListButton) {
            couponListButton.addEventListener('click', function() {
                fetchAvailableCoupons();
                couponModal.style.display = "block";
            });
        }

        if (closeModal) {
            closeModal.addEventListener('click', function() {
                couponModal.style.display = "none";
            });
        }

        if (removeCouponButton) {
            removeCouponButton.addEventListener('click', function() {
                removeCoupon();
            });
        }

        window.addEventListener('click', function(event) {
            if (event.target == couponModal) {
                couponModal.style.display = "none";
            }
        });
    
        function applyCoupon(couponCode) {
            fetch(`/cart/apply-coupon/${couponCode}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Toastify({
                        text: data.message,
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "green",
                    }).showToast();
                    location.reload();
                } else {
                    Toastify({
                        text: data.message,
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "red",
                    }).showToast();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Toastify({
                    text: "An error occurred while applying the coupon. Please try again.",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "red",
                }).showToast();
            });
        }
    
        function fetchAvailableCoupons() {
            fetch('/cart/available-coupons/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            })
            .then(response => response.json())
            .then(data => {
                const couponList = document.getElementById('couponList');
                couponList.innerHTML = '';
                data.coupons.forEach(coupon => {
                    const couponElement = document.createElement('div');
                    couponElement.textContent = `${coupon.code} - ${coupon.description}`;
                    couponElement.style.cursor = 'pointer';
                    couponElement.addEventListener('click', function() {
                        applyCoupon(coupon.code);
                        couponModal.style.display = "none";
                    });
                    couponList.appendChild(couponElement);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('An error occurred while fetching available coupons.', 'error');
            });
        }
    
        function removeCoupon() {
            fetch('/cart/remove-coupon/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Coupon removed successfully', 'success');
                    location.reload();
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('An error occurred while removing the coupon. Please try again.', 'error');
            });
        }
    
        function updateOrderSummary(data) {
            document.querySelector('.summary-total span:last-child').textContent = `₹${parseFloat(data.new_total).toFixed(2)}`;
            const summaryItems = document.querySelector('.order-summary');
            let couponItem = summaryItems.querySelector('.summary-item:nth-last-child(2)');
            if (couponItem && couponItem.textContent.includes('Coupon Applied')) {
                couponItem.querySelector('span:last-child').textContent = `-₹${parseFloat(data.discount_amount).toFixed(2)}`;
            } else {
                couponItem = document.createElement('div');
                couponItem.className = 'summary-item';
                couponItem.innerHTML = `<span>Coupon Applied</span><span>-₹${parseFloat(data.discount_amount).toFixed(2)}</span>`;
                summaryItems.insertBefore(couponItem, summaryItems.querySelector('.summary-total'));
            }
            const couponSection = document.querySelector('.coupon-section');
            const appliedCouponDiv = document.createElement('div');
            appliedCouponDiv.innerHTML = `
                <div>
                    <span>Applied Coupon: <strong>${data.coupon_code}</strong></span>
                    <button id="removeCouponButton" class="coupon-button">Remove Coupon</button>
                </div>
            `;
            couponSection.innerHTML = '';
            couponSection.appendChild(appliedCouponDiv);
            document.getElementById('removeCouponButton').addEventListener('click', removeCoupon);
        }
    
        function showMessage(message, type) {
            const popup = document.createElement('div');
            popup.className = `popup ${type}`;
            popup.textContent = message;
            document.body.appendChild(popup);
            popup.classList.add('show');
            setTimeout(() => {
                popup.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(popup);
                }, 300);
            }, 5000);
        }
    });
</script>
{% endblock %}
