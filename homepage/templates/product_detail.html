{% extends "base_user.html" %}
{% load static %}

{% block title %}{{ product.name }}{% endblock %}

{% block link %}
<link rel="stylesheet" href="{% static 'css/product_detail.css' %}">
{% endblock %}

{% block style %}
{% endblock %}

{% block body %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'product_listing' %}">Products</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
        </ol>
    </nav>

    <!-- Product Details -->
    <div class="row">
        <!-- Product Gallery -->
        <div class="col-md-6">
            <div class="product-gallery">
                <div class="product-image-container img-magnifier-container">
                    <img src="{{ product.images.first.image }}" class="product-image" id="mainImage" alt="{{ product.name }}">
                    <div class="image-zoom-result" id="imageZoomResult"></div>
                    <button class="image-nav-button prev" onclick="changeImage(-1)">&#10094;</button>
                    <button class="image-nav-button next" onclick="changeImage(1)">&#10095;</button>
                </div>
                <div class="thumbnail-gallery">
                    {% for image in product.images.all %}
                    <img src="{{ image.image }}" class="thumbnail {% if forloop.first %}active{% endif %}" 
                         alt="Product thumbnail" onclick="setActiveImage({{ forloop.counter0 }})">
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Product Info -->
        <div class="col-md-6">
            <div class="product-info">
                <h1>{{ product.name }}</h1>
                <div class="product-rating">
                    {% with ''|center:5 as range %}
                    {% for _ in range %}
                        {% if forloop.counter <= avg_rating|floatformat:0|add:"0" %}
                            <span class="star filled">★</span>
                        {% else %}
                            <span class="star">☆</span>
                        {% endif %}
                    {% endfor %}
                    {% endwith %}
                    <span class="review-count">({{ review_count }} reviews)</span>
                </div>
                <div class="sale-price" id="salePrice">₹{{ product.variants.first.sale_price }}</div>
                <div class="original-price" id="actualPrice">₹{{ product.variants.first.actual_price }}</div>
                
                <!-- Variant Selection -->
                <div class="variant-select">
                    <div class="mb-3">
                        <label for="sizeSelect" class="form-label">Select Size</label>
                        <select class="form-select" id="sizeSelect"></select>
                    </div>
                    <div class="mb-3">
                        <label for="colorSelect" class="form-label">Select Color</label>
                        <select class="form-select" id="colorSelect"></select>
                    </div>
                </div>
    
                <!-- Buy Now and Add to Cart Buttons -->
                <div class="d-flex align-items-center mb-3">
                    <form method="POST" action="{% url 'add_to_cart' product.id %}" class="d-flex w-100 gap-2" id="addToCartForm">
                        {% csrf_token %}
                        <input type="hidden" name="variant" id="variantId" value="{{ product.variants.first.id }}">
                        <input type="hidden" name="quantity" value="1">
                        <div class="w-100 d-flex gap-2" id="productActions">
                        </div>
                        <button type="button" class="wishlist-btn {% if is_wishlisted %}active{% endif %}" 
                                data-product-id="{{ product.id }}" 
                                onclick="toggleWishlist(this, '{{ product.variants.first.size }}')">
                            <i class="fas fa-heart"></i>
                        </button>
                    </form>
                </div>

                <!-- Description -->
                <div class="description">
                    <h5>Description</h5>
                    <p>{{ product.description }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- You May Also Like Section -->
    <section class="my-5">
        <h2 class="mb-4">You May Also Like</h2>
        <div class="row row-cols-2 row-cols-md-4 g-4">
            {% for related_product in related_products %}
            <div class="col">
                <div class="card h-100">
                    <a href="{% url 'product_detail' related_product.id %}" class="text-decoration-none">
                        <img src="{{ related_product.images.first.image }}" class="card-img-top" alt="{{ related_product.name }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ related_product.name|truncatechars:15 }}</h5>
                            <div class="product-rating">
                                {% with ''|center:5 as range %}
                            {% for _ in range %}
                                {% if forloop.counter <= related_product.avg_rating|floatformat:0|add:"0" %}
                                    <span class="star filled">★</span>
                                {% else %}
                                    <span class="star">☆</span>
                                {% endif %}
                            {% endfor %}
                            {% endwith %}
                            <span class="review-count">({{ related_product.review_count }})</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="original-price">₹{{ related_product.variants.first.sale_price }}</span>
                                <span class="card-text" style="color: #dc3545; margin-left: 0.5rem;">₹{{ related_product.variants.first.actual_price }}</span>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Customer Reviews Section -->
    <section class="my-5">
        <h2 class="mb-4"><strong>Customer Reviews</strong></h2>
        <div class="row">
            {% if reviews %}
                {% for review in reviews %}
                    <div class="review-item">
                        <div class="review-header">
                            <h5><span class="review-author"><strong>{{ review.user.first_name }} {{ review.user.last_name }}</strong></span></h5><br>
                            <span class="review-date">{{ review.created_at|date:"F d, Y" }}</span>
                        </div>
                        <div class="review-rating">
                            {% with ''|center:5 as range %}
                            {% for _ in range %}
                                {% if forloop.counter <= review.rating %}
                                    <span class="star filled">★</span>
                                {% else %}
                                    <span class="star">☆</span>
                                {% endif %}
                            {% endfor %}
                            {% endwith %}
                        </div>
                        {% if review.title %}
                            <h5 class="review-title">{{ review.title }}</h5>
                        {% endif %}
                        <p>{{ review.comment }}</p>
                    </div>
                {% endfor %}
            {% else %}
                <p>No reviews yet. Be the first to review this product!</p>
            {% endif %}
        </div>
    </section>
</div>

<script>
let currentImageIndex = 0;
const images = [
    {% for image in product.images.all %}
    "{{ image.image }}",
    {% endfor %}
];

function setActiveImage(index) {
    currentImageIndex = index;
    const mainImage = document.getElementById('mainImage');
    mainImage.src = images[index];
    magnify("mainImage", 1.5); //this line ensures the zoom is re-applied to the new image
    updateThumbnails();
}

function changeImage(direction) {
    currentImageIndex = (currentImageIndex + direction + images.length) % images.length;
    setActiveImage(currentImageIndex);
}

function updateThumbnails() {
    const thumbnails = document.querySelectorAll('.thumbnail');
    thumbnails.forEach((thumb, index) => {
        if (index === currentImageIndex) {
            thumb.classList.add('active');
        } else {
            thumb.classList.remove('active');
        }
    });
}

function toggleWishlist(button, initialSize) {
    const productId = button.dataset.productId;
    const productSize = document.getElementById('sizeSelect').value || initialSize;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(`/userpanel/toggle-wishlist/${productId}/${productSize}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.classList.toggle('active');
            showMessage(data.message, 'success');
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('An error occurred. Please try again.', 'error');
    });
}

// Update wishlist button when size changes
document.getElementById('sizeSelect').addEventListener('change', function() {
    const wishlistButton = document.querySelector('.wishlist-btn');
    wishlistButton.classList.remove('active');
});

const mainImage = document.getElementById('mainImage');
const zoomResult = document.getElementById('imageZoomResult');

mainImage.addEventListener('mousemove', function(e) {
    const rect = mainImage.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const xPercent = (x / rect.width) * 100;
    const yPercent = (y / rect.height) * 100;

    zoomResult.style.backgroundImage = `url('${mainImage.src}')`;
    zoomResult.style.backgroundPosition = `${xPercent}% ${yPercent}%`;
    zoomResult.style.display = 'block';
});

mainImage.addEventListener('mouseleave', function() {
    zoomResult.style.display = 'none';
});

let lastScrollTop = 0;
const gallery = document.querySelector('.product-gallery');
const description = document.querySelector('.description');

window.addEventListener('scroll', function() {
    let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    let galleryRect = gallery.getBoundingClientRect();
    let descriptionRect = description.getBoundingClientRect();

    if (galleryRect.bottom <= descriptionRect.bottom) {
        if (scrollTop > lastScrollTop) {
            gallery.style.position = 'sticky';
            gallery.style.top = '0';
        } else {
            if (galleryRect.top >= 0) {
                gallery.style.position = 'sticky';
                gallery.style.top = '0';
            } else {
                gallery.style.position = 'relative';
            }
        }
    } else {
        gallery.style.position = 'relative';
    }

    lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
});

document.addEventListener('DOMContentLoaded', function() {
    setActiveImage(0);
});
const availableVariants = {{ available_variants|safe }};
let currentSize = null;
let currentColor = null;

function updateSizeOptions() {
    const sizeSelect = document.getElementById('sizeSelect');
    const availableSizes = [...new Set(availableVariants.map(v => v.size))];
    
    sizeSelect.innerHTML = '';
    availableSizes.forEach(size => {
        const option = document.createElement('option');
        option.value = size;
        option.textContent = size;
        sizeSelect.appendChild(option);
    });
    
    if (currentSize && availableSizes.includes(currentSize)) {
        sizeSelect.value = currentSize;
    } else {
        currentSize = availableSizes[0];
        sizeSelect.value = currentSize;
    }
}

function updateColorOptions() {
    const colorSelect = document.getElementById('colorSelect');
    const availableColors = [...new Set(availableVariants.filter(v => v.size === currentSize).map(v => v.color))];
    
    colorSelect.innerHTML = '';
    availableColors.forEach(color => {
        const option = document.createElement('option');
        option.value = color;
        option.textContent = color;
        colorSelect.appendChild(option);
    });
    
    if (currentColor && availableColors.includes(currentColor)) {
        colorSelect.value = currentColor;
    } else {
        currentColor = availableColors[0];
        colorSelect.value = currentColor;
    }
}

function updateVariantDetails() {
    const variant = availableVariants.find(v => v.size === currentSize && v.color === currentColor);
    const productActions = document.getElementById('productActions');
    
    if (variant) {
        document.getElementById('salePrice').textContent = `₹${variant.sale_price}`;
        document.getElementById('actualPrice').textContent = `₹${variant.actual_price}`;
        document.getElementById('variantId').value = variant.id;

        // Clear previous content
        productActions.innerHTML = '';

        if (parseInt(variant.quantity) > 0) {
            // In stock - show action buttons
            productActions.innerHTML = `
                <button type="submit" class="btn btn-primary btn-lg flex-grow-1" id="buyNowBtn">Buy Now</button>
                <button type="submit" class="btn btn-dark btn-lg flex-grow-1" id="addToCartBtn">Add to Cart</button>
            `;
        } else {
            // Out of stock - show message
            productActions.innerHTML = `
                <div class="out-of-stock w-100 text-center py-2 px-3 rounded">
                    Out of Stock
                </div>
            `;
        }
    } else {
        console.error('Variant not found');
        productActions.innerHTML = `
            <div class="out-of-stock w-100 text-center py-2 px-3 rounded">
                Variant Not Available
            </div>
        `;
    }
}
document.addEventListener('DOMContentLoaded', function() {
    updateSizeOptions();
    updateColorOptions();
    updateVariantDetails();
});

function handleSizeChange() {
    currentSize = document.getElementById('sizeSelect').value;
    updateColorOptions();
    updateVariantDetails();
}

function handleColorChange() {
    currentColor = document.getElementById('colorSelect').value;
    updateVariantDetails();
}

document.getElementById('sizeSelect').addEventListener('change', handleSizeChange);
document.getElementById('colorSelect').addEventListener('change', handleColorChange);

document.addEventListener('DOMContentLoaded', function() {
    updateSizeOptions();
    updateColorOptions();
    updateVariantDetails();
});
    

//zoom effect
function magnify(imgID, zoom) {
  var img, glass, w, h, bw;
  img = document.getElementById(imgID);

    // Check if magnifier glass already exists and remove it
    let existingGlass = img.parentElement.querySelector(".img-magnifier-glass");
    if (existingGlass) {
        existingGlass.remove();
    }
  
  /* Create magnifier glass: */
  glass = document.createElement("DIV");
  glass.setAttribute("class", "img-magnifier-glass");

  /* Insert magnifier glass: */
  img.parentElement.insertBefore(glass, img);

  /* Set background properties for the magnifier glass: */
  glass.style.backgroundImage = "url('" + img.src + "')";
  glass.style.backgroundRepeat = "no-repeat";
  glass.style.backgroundSize = (img.width * zoom) + "px " + (img.height * zoom) + "px";
  bw = 3;
  w = glass.offsetWidth / 2;
  h = glass.offsetHeight / 2;

  // Initially hide the magnifier
  glass.style.display = "none"; // <-- Initially hide the magnifier

  /* Execute a function when someone moves the magnifier glass over the image: */
  glass.addEventListener("mousemove", moveMagnifier);
  img.addEventListener("mousemove", moveMagnifier);

  /* and also for touch screens: */
  glass.addEventListener("touchmove", moveMagnifier);
  img.addEventListener("touchmove", moveMagnifier);

  /* Hide the magnifier when the mouse leaves the image or the magnifier: */
  img.addEventListener("mouseleave", function() {
    glass.style.display = "none"; // <-- Hide the magnifier
  });
  
  glass.addEventListener("mouseleave", function() {
    glass.style.display = "none"; // <-- Hide the magnifier
  });

  /* Show the magnifier when hovering over the image */
  img.addEventListener("mouseenter", function() {
    glass.style.display = "block"; // <-- Show the magnifier
  });

  function moveMagnifier(e) {
    var pos, x, y;
    /* Prevent any other actions that may occur when moving over the image */
    e.preventDefault();
    /* Get the cursor's x and y positions: */
    pos = getCursorPos(e);
    x = pos.x;
    y = pos.y;
    /* Prevent the magnifier glass from being positioned outside the image: */
    if (x > img.width - (w / zoom)) {x = img.width - (w / zoom);}
    if (x < w / zoom) {x = w / zoom;}
    if (y > img.height - (h / zoom)) {y = img.height - (h / zoom);}
    if (y < h / zoom) {y = h / zoom;}
    /* Set the position of the magnifier glass: */
    glass.style.left = (x - w) + "px";
    glass.style.top = (y - h) + "px";
    /* Display what the magnifier glass "sees": */
    glass.style.backgroundPosition = "-" + ((x * zoom) - w + bw) + "px -" + ((y * zoom) - h + bw) + "px";
  }

  function getCursorPos(e) {
    var a, x = 0, y = 0;
    e = e || window.event;
    /* Get the x and y positions of the image: */
    a = img.getBoundingClientRect();
    /* Calculate the cursor's x and y coordinates, relative to the image: */
    x = e.pageX - a.left;
    y = e.pageY - a.top;
    /* Consider any page scrolling: */
    x = x - window.pageXOffset;
    y = y - window.pageYOffset;
    return {x : x, y : y};
  }
}

magnify("mainImage", 1.2);
</script>
{% endblock %}
