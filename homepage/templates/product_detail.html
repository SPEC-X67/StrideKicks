{% extends "base_user.html" %}
{% load static %}

{% block title %}{{ product.name }}{% endblock %}

{% block link %}
{% endblock %}

{% block style %}
<style>
.breadcrumb {
    background: transparent;
    padding: 0;
    margin-bottom: 1.5rem;
}
.breadcrumb-item a {
    color: #6c757d;
    text-decoration: none;
}
.breadcrumb-item.active {
    color: #333;
}
.breadcrumb-item + .breadcrumb-item::before {
    content: ">";
}
.product-gallery {
    position: sticky;
    top: 2rem;
}
.product-image-container {
    position: relative;
    overflow: hidden;
}
.product-image {
    width: 100%;
    height: auto;
    cursor: crosshair;
}
.image-zoom-result {
    position: absolute;
    top: 0;
    right: -100%;
    width: 100%;
    height: 100%;
    background-repeat: no-repeat;
    background-size: 1000%;
    display: none;
    z-index: 1000;
    border: 1px solid #ddd;
    overflow: hidden;
}
* {box-sizing: border-box;}
.img-magnifier-container {
    position: relative;
}
.img-magnifier-glass {
    position: absolute;
    border-radius: 50%;
    cursor: none;
    width: 60%;
    height: 60%;
    /* transition: top 0.05s ease, left 0.05s ease; */
    z-index: 1000;
}
/* ------ */
.image-nav-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.7);
    border: none;
    font-size: 2rem;
    padding: 0.5rem;
    cursor: pointer;
}
.image-nav-button.prev {
    left: 10px;
}
.image-nav-button.next {
    right: 10px;
}
.thumbnail-gallery {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}
.thumbnail {
    width: 80px;
    height: 80px;
    object-fit: cover;
    cursor: pointer;
    border: 2px solid transparent;
}
.thumbnail.active {
    border-color: #000;
}
.product-rating {
    color: #ffd700;
    margin-bottom: 5px;
}
.product-info {
    padding-left: 2rem;
}
.variant-select {
    margin-bottom: 1.5rem;
}
.description {
    margin-top: 2rem;
}
.wishlist-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #ccc;
    transition: color 0.3s;
}
.wishlist-btn.active {
    color: red;
}
.sale-price {
    color: #dc3545;
    margin-left: 0.5rem;
    font-weight: bold;
    font-size: x-large;
}
.original-price {
    text-decoration: line-through;
    color: #6c757d;
    font-size: 0.9em;
}
</style>
{% endblock %}

{% block body %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="#">Products</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
        </ol>
    </nav>

    <!-- Product Details -->
    <div class="row">
        <!-- Product Gallery -->
        <div class="col-md-6">
            <div class="product-gallery">
                <!-- <div class="product-image-container">
                    <img src="{{ product.images.first.image }}" class="product-image" id="mainImage" alt="{{ product.name }}">
                    <div class="image-zoom-result" id="imageZoomResult"></div>
                    <button class="image-nav-button prev" onclick="changeImage(-1)">&#10094;</button>
                    <button class="image-nav-button next" onclick="changeImage(1)">&#10095;</button>
                </div> -->
                <div class="product-image-container img-magnifier-container">
                    <img src="{{ product.images.first.image }}" class="product-image" id="mainImage" alt="{{ product.name }}">
                    <div class="image-zoom-result" id="imageZoomResult"></div>
                    <button class="image-nav-button prev" onclick="changeImage(-1)">&#10094;</button>
                    <button class="image-nav-button next" onclick="changeImage(1)">&#10095;</button>
                </div>
                <div class="thumbnail-gallery">
                    {% for image in product.images.all %}
                    <img src="{{ image.image }}" class="thumbnail {% if forloop.first %}active{% endif %}" 
                         alt="Product thumbnail" onclick="setActiveImage({{ forloop.counter0 }})">
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Product Info -->
        <div class="col-md-6">
            <div class="product-info">
                <h1>{{ product.name }}</h1>
                <div class="product-rating">
                    {% for i in "12345"|make_list %}
                        {% if forloop.counter <= product.rating %}
                            ★
                        {% else %}
                            ☆
                        {% endif %}
                    {% endfor %}
                    ({{ product.rating }}.0)
                </div>
                <div class="sale-price" id="salePrice">₹{{ product.variants.first.sale_price }}</div>
                <div class="original-price" id="actualPrice">₹{{ product.variants.first.actual_price }}</div>
                
                <!-- Variant Selection -->
                <div class="variant-select">
                    <div class="mb-3">
                        <label for="sizeSelect" class="form-label">Select Size</label>
                        <select class="form-select" id="sizeSelect"></select>
                    </div>
                    <div class="mb-3">
                        <label for="colorSelect" class="form-label">Select Color</label>
                        <select class="form-select" id="colorSelect"></select>
                    </div>
                </div>
    
                <!-- Buy Now and Add to Cart Buttons -->
                <div class="d-flex align-items-center mb-3">
                    <form method="POST" action="{% url 'add_to_cart' product.id %}" class="d-flex w-100 gap-2">
                        {% csrf_token %}
                        <input type="hidden" name="variant" id="variantId" value="{{ product.variants.first.id }}">
                        <input type="hidden" name="quantity" value="1">
                        <button type="submit" class="btn btn-primary btn-lg flex-grow-1" id="buyNowBtn">Buy Now</button>
                        <button type="submit" class="btn btn-dark btn-lg flex-grow-1" id="addToCartBtn">Add to Cart</button>
                        <button type="button" class="wishlist-btn {% if is_wishlisted %}active{% endif %}" 
                                data-product-id="{{ product.id }}" 
                                onclick="toggleWishlist(this, '{{ product.variants.first.size }}')">
                            <i class="fas fa-heart"></i>
                        </button>
                    </form>
                </div>

                <!-- Description -->
                <div class="description">
                    <h5>Description</h5>
                    <p>{{ product.description }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- You May Also Like Section -->
    <section class="my-5">
        <h2 class="mb-4">You May Also Like</h2>
        <div class="row row-cols-2 row-cols-md-4 g-4">
            {% for related_product in related_products %}
            <div class="col">
                <div class="card h-100">
                    <a href="{% url 'product_detail' related_product.id %}" class="text-decoration-none">
                        <img src="{{ related_product.images.first.image }}" class="card-img-top" alt="{{ related_product.name }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ related_product.name }}</h5>
                            <div class="product-rating">
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= product.rating %}
                                        ★
                                    {% else %}
                                        ☆
                                    {% endif %}
                                {% endfor %}
                                ({{ product.rating }}.0)
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="original-price">₹{{ related_product.variants.first.sale_price }}</span>
                                <span class="card-text" style="color: #dc3545; margin-left: 0.5rem;">₹{{ related_product.variants.first.actual_price }}</span>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Customer Reviews Section -->
    <section class="my-5">
        <h2 class="mb-4">Customer Reviews</h2>
        <div class="row">
            <!-- Review 1 -->
            <div class="col-md-6 mb-4">
                <div class="review p-3 border rounded">
                    <h5>John Doe</h5>
                    <p class="text-muted">⭐⭐⭐⭐☆</p>
                    <p>"This product exceeded my expectations! The quality is excellent, and it arrived on time. Highly recommended!"</p>
                    <small class="text-muted">Reviewed on October 10, 2024</small>
                </div>
            </div>
            
            <!-- Review 2 -->
            <div class="col-md-6 mb-4">
                <div class="review p-3 border rounded">
                    <h5>Jane Smith</h5>
                    <p class="text-muted">⭐⭐⭐⭐⭐</p>
                    <p>"Absolutely love it! Great value for the price. Will definitely buy again."</p>
                    <small class="text-muted">Reviewed on September 22, 2024</small>
                </div>
            </div>

            <!-- Review 3 -->
            <div class="col-md-6 mb-4">
                <div class="review p-3 border rounded">
                    <h5>Michael Brown</h5>
                    <p class="text-muted">⭐⭐⭐☆☆</p>
                    <p>"Good product but could use some improvements. The delivery was delayed, but overall satisfied."</p>
                    <small class="text-muted">Reviewed on August 15, 2024</small>
                </div>
            </div>

            <!-- Review 4 -->
            <div class="col-md-6 mb-4">
                <div class="review p-3 border rounded">
                    <h5>Emily White</h5>
                    <p class="text-muted">⭐⭐⭐⭐⭐</p>
                    <p>"Perfect! Exactly as described. The customer service was also fantastic."</p>
                    <small class="text-muted">Reviewed on July 30, 2024</small>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
let currentImageIndex = 0;
const images = [
    {% for image in product.images.all %}
    "{{ image.image }}",
    {% endfor %}
];

function setActiveImage(index) {
    currentImageIndex = index;
    const mainImage = document.getElementById('mainImage');
    mainImage.src = images[index];
    magnify("mainImage", 1.5); //this line ensures the zoom is re-applied to the new image
    updateThumbnails();
}

function changeImage(direction) {
    currentImageIndex = (currentImageIndex + direction + images.length) % images.length;
    setActiveImage(currentImageIndex);
}

function updateThumbnails() {
    const thumbnails = document.querySelectorAll('.thumbnail');
    thumbnails.forEach((thumb, index) => {
        if (index === currentImageIndex) {
            thumb.classList.add('active');
        } else {
            thumb.classList.remove('active');
        }
    });
}

function toggleWishlist(button, initialSize) {
    const productId = button.dataset.productId;
    const productSize = document.getElementById('sizeSelect').value || initialSize;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(`/userpanel/toggle-wishlist/${productId}/${productSize}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.classList.toggle('active');
            showMessage(data.message, 'success');
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('An error occurred. Please try again.', 'error');
    });
}

// Update wishlist button when size changes
document.getElementById('sizeSelect').addEventListener('change', function() {
    const wishlistButton = document.querySelector('.wishlist-btn');
    wishlistButton.classList.remove('active');
});

const mainImage = document.getElementById('mainImage');
const zoomResult = document.getElementById('imageZoomResult');

mainImage.addEventListener('mousemove', function(e) {
    const rect = mainImage.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const xPercent = (x / rect.width) * 100;
    const yPercent = (y / rect.height) * 100;

    zoomResult.style.backgroundImage = `url('${mainImage.src}')`;
    zoomResult.style.backgroundPosition = `${xPercent}% ${yPercent}%`;
    zoomResult.style.display = 'block';
});

mainImage.addEventListener('mouseleave', function() {
    zoomResult.style.display = 'none';
});

let lastScrollTop = 0;
const gallery = document.querySelector('.product-gallery');
const description = document.querySelector('.description');

window.addEventListener('scroll', function() {
    let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    let galleryRect = gallery.getBoundingClientRect();
    let descriptionRect = description.getBoundingClientRect();

    if (galleryRect.bottom <= descriptionRect.bottom) {
        if (scrollTop > lastScrollTop) {
            gallery.style.position = 'sticky';
            gallery.style.top = '0';
        } else {
            if (galleryRect.top >= 0) {
                gallery.style.position = 'sticky';
                gallery.style.top = '0';
            } else {
                gallery.style.position = 'relative';
            }
        }
    } else {
        gallery.style.position = 'relative';
    }

    lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
});

document.addEventListener('DOMContentLoaded', function() {
    setActiveImage(0);
});
const availableVariants = {{ available_variants|safe }};
let currentSize = null;
let currentColor = null;

function updateSizeOptions() {
    const sizeSelect = document.getElementById('sizeSelect');
    const availableSizes = [...new Set(availableVariants.map(v => v.size))];
    
    sizeSelect.innerHTML = '';
    availableSizes.forEach(size => {
        const option = document.createElement('option');
        option.value = size;
        option.textContent = size;
        sizeSelect.appendChild(option);
    });
    
    if (currentSize && availableSizes.includes(currentSize)) {
        sizeSelect.value = currentSize;
    } else {
        currentSize = availableSizes[0];
        sizeSelect.value = currentSize;
    }
}

function updateColorOptions() {
    const colorSelect = document.getElementById('colorSelect');
    const availableColors = [...new Set(availableVariants.filter(v => v.size === currentSize).map(v => v.color))];
    
    colorSelect.innerHTML = '';
    availableColors.forEach(color => {
        const option = document.createElement('option');
        option.value = color;
        option.textContent = color;
        colorSelect.appendChild(option);
    });
    
    if (currentColor && availableColors.includes(currentColor)) {
        colorSelect.value = currentColor;
    } else {
        currentColor = availableColors[0];
        colorSelect.value = currentColor;
    }
}

function updateVariantDetails() {
    const variant = availableVariants.find(v => v.size === currentSize && v.color === currentColor);
    
    if (variant) {
        document.getElementById('salePrice').textContent = `₹${variant.sale_price}`;
        document.getElementById('actualPrice').textContent = `₹${variant.actual_price}`;
        document.getElementById('variantId').value = variant.id;

        const buyNowBtn = document.getElementById('buyNowBtn');
        const addToCartBtn = document.getElementById('addToCartBtn');

        if (variant.quantity > 0) {
            buyNowBtn.disabled = false;
            addToCartBtn.disabled = false;
            buyNowBtn.textContent = 'Buy Now';
            addToCartBtn.textContent = 'Add to Cart';
        } else {
            buyNowBtn.disabled = true;
            addToCartBtn.disabled = true;
            buyNowBtn.textContent = 'Sold Out';
            addToCartBtn.textContent = 'Sold Out';
        }
    } else {
        console.error('Variant not found');
    }
}

function handleSizeChange() {
    currentSize = document.getElementById('sizeSelect').value;
    updateColorOptions();
    updateVariantDetails();
}

function handleColorChange() {
    currentColor = document.getElementById('colorSelect').value;
    updateVariantDetails();
}

document.getElementById('sizeSelect').addEventListener('change', handleSizeChange);
document.getElementById('colorSelect').addEventListener('change', handleColorChange);

document.addEventListener('DOMContentLoaded', function() {
    updateSizeOptions();
    updateColorOptions();
    updateVariantDetails();
});
    

//zoom effect
function magnify(imgID, zoom) {
  var img, glass, w, h, bw;
  img = document.getElementById(imgID);

    // Check if magnifier glass already exists and remove it
    let existingGlass = img.parentElement.querySelector(".img-magnifier-glass");
    if (existingGlass) {
        existingGlass.remove();
    }
  
  /* Create magnifier glass: */
  glass = document.createElement("DIV");
  glass.setAttribute("class", "img-magnifier-glass");

  /* Insert magnifier glass: */
  img.parentElement.insertBefore(glass, img);

  /* Set background properties for the magnifier glass: */
  glass.style.backgroundImage = "url('" + img.src + "')";
  glass.style.backgroundRepeat = "no-repeat";
  glass.style.backgroundSize = (img.width * zoom) + "px " + (img.height * zoom) + "px";
  bw = 3;
  w = glass.offsetWidth / 2;
  h = glass.offsetHeight / 2;

  // Initially hide the magnifier
  glass.style.display = "none"; // <-- Initially hide the magnifier

  /* Execute a function when someone moves the magnifier glass over the image: */
  glass.addEventListener("mousemove", moveMagnifier);
  img.addEventListener("mousemove", moveMagnifier);

  /* and also for touch screens: */
  glass.addEventListener("touchmove", moveMagnifier);
  img.addEventListener("touchmove", moveMagnifier);

  /* Hide the magnifier when the mouse leaves the image or the magnifier: */
  img.addEventListener("mouseleave", function() {
    glass.style.display = "none"; // <-- Hide the magnifier
  });
  
  glass.addEventListener("mouseleave", function() {
    glass.style.display = "none"; // <-- Hide the magnifier
  });

  /* Show the magnifier when hovering over the image */
  img.addEventListener("mouseenter", function() {
    glass.style.display = "block"; // <-- Show the magnifier
  });

  function moveMagnifier(e) {
    var pos, x, y;
    /* Prevent any other actions that may occur when moving over the image */
    e.preventDefault();
    /* Get the cursor's x and y positions: */
    pos = getCursorPos(e);
    x = pos.x;
    y = pos.y;
    /* Prevent the magnifier glass from being positioned outside the image: */
    if (x > img.width - (w / zoom)) {x = img.width - (w / zoom);}
    if (x < w / zoom) {x = w / zoom;}
    if (y > img.height - (h / zoom)) {y = img.height - (h / zoom);}
    if (y < h / zoom) {y = h / zoom;}
    /* Set the position of the magnifier glass: */
    glass.style.left = (x - w) + "px";
    glass.style.top = (y - h) + "px";
    /* Display what the magnifier glass "sees": */
    glass.style.backgroundPosition = "-" + ((x * zoom) - w + bw) + "px -" + ((y * zoom) - h + bw) + "px";
  }

  function getCursorPos(e) {
    var a, x = 0, y = 0;
    e = e || window.event;
    /* Get the x and y positions of the image: */
    a = img.getBoundingClientRect();
    /* Calculate the cursor's x and y coordinates, relative to the image: */
    x = e.pageX - a.left;
    y = e.pageY - a.top;
    /* Consider any page scrolling: */
    x = x - window.pageXOffset;
    y = y - window.pageYOffset;
    return {x : x, y : y};
  }
}

magnify("mainImage", 1.2);
</script>
{% endblock %}
