{% extends "base.html" %}

{% block title %}Reset password{% endblock %}

{% block style %}
<style>
    .auth-container {
        min-height: 100vh;
        display: flex;
        align-items: stretch;
    }
    
    .auth-form-side {
        flex: 1;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        max-width: 500px;
    }
    
    .auth-image-side {
        flex: 1;
        background-image: url('{% static "images/auth-bg.jpg" %}');
        background-size: cover;
        background-position: center;
        display: none;
    }
    
    .auth-form {
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
    }
    
    .form-title {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #333;
    }
    
    .form-subtitle {
        color: #666;
        margin-bottom: 2rem;
    }
    
    .form-control {
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        border: 1px solid #ddd;
        margin-bottom: 1rem;
    }
    
    .password-input-wrapper {
        position: relative;
    }
    
    .password-toggle {
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        cursor: pointer;
        color: #6c757d;
        background: none;
        border: none;
    }
    
    .btn-primary {
        width: 100%;
        padding: 0.75rem;
        border-radius: 0.5rem;
        background-color: #333;
        color: white;
        border: none;
        font-weight: 500;
        margin-top: 1rem;
    }
    
    .btn-primary:hover {
        background-color: #222;
    }
    
    .btn-link {
        background: none;
        border: none;
        color: #007bff;
        padding: 0;
        font-size: 0.9rem;
        cursor: pointer;
    }
    
    .btn-link:disabled {
        color: #6c757d;
        cursor: not-allowed;
    }
    
    .otp-timer {
        font-size: 0.9rem;
        color: #666;
        margin-top: 0.5rem;
    }
    
    .message-error {
        color: #dc3545;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 15px;
        text-align: center;
    }
    
    .message-success {
        color: #28a745;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 15px;
        text-align: center;
    }
    
    @media (min-width: 768px) {
        .auth-image-side {
            display: block;
        }
    }
</style>
{% endblock %}

{% block body %}
<div class="auth-container">
    <div class="auth-form-side">
        <div class="auth-form">
            <h1 class="form-title">Reset Password</h1>
            <p class="form-subtitle">Welcome back, {{ user.first_name }}!</p>

            {% if messages %}
            {% for message in messages %}
                {% if message.tags == 'error' %}
                    <div class="message-error">{{ message }}</div>
                {% elif message.tags == 'success' %}
                    <div class="message-success">{{ message }}</div>
                {% endif %}
            {% endfor %}
            {% endif %}

            <form method="POST" action="{% url 'reset_password' %}">
                {% csrf_token %}
                <input type="hidden" name="user_id" value="{{ user.user_id }}">
                
                <div class="mb-3">
                    <label for="otp" class="form-label">Enter OTP</label>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="otp" 
                        name="otp" 
                        required 
                        maxlength="6"
                        pattern="\d{6}"
                        title="Please enter 6 digits"
                    >
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div class="otp-timer" id="otpExpiryTimer"></div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="otp-timer" id="resendTimer"></span>
                            <button 
                                type="button" 
                                class="btn-link" 
                                id="resendButton" 
                                onclick="resendOTP()"
                                disabled
                            >
                                Resend OTP
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="new_password" class="form-label">New Password</label>
                    <div class="password-input-wrapper">
                        <input 
                            type="password" 
                            class="form-control" 
                            id="new_password" 
                            name="new_password" 
                            required
                            minlength="8"
                        >
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('new_password')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="confirm_password" class="form-label">Retype Password</label>
                    <div class="password-input-wrapper">
                        <input 
                            type="password" 
                            class="form-control" 
                            id="confirm_password" 
                            name="confirm_password" 
                            required
                            minlength="8"
                        >
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('confirm_password')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Reset Password</button>
            </form>
        </div>
    </div>
    <div class="auth-image-side"></div>
</div>

<script>
let otpExpiryTime;
let resendTime;

function initializeTimers() {
    // Get stored times from sessionStorage
    const storedOtpExpiry = sessionStorage.getItem('otpExpiryTime');
    const storedResendTime = sessionStorage.getItem('resendTime');
    
    // Set initial times or use stored times
    otpExpiryTime = storedOtpExpiry ? new Date(storedOtpExpiry) : new Date(Date.now() + 5 * 60 * 1000);
    resendTime = storedResendTime ? new Date(storedResendTime) : new Date(Date.now() + 30 * 1000);
    
    // Store times in sessionStorage
    sessionStorage.setItem('otpExpiryTime', otpExpiryTime.toISOString());
    sessionStorage.setItem('resendTime', resendTime.toISOString());
    
    updateTimers();
}

function updateTimers() {
    const now = new Date();
    
    // Update OTP expiry timer
    const otpTimeLeft = Math.max(0, Math.floor((otpExpiryTime - now) / 1000));
    const otpMinutes = Math.floor(otpTimeLeft / 60);
    const otpSeconds = otpTimeLeft % 60;
    document.getElementById('otpExpiryTimer').textContent = 
        `OTP expires in ${otpMinutes}:${otpSeconds.toString().padStart(2, '0')}`;
    
    // Update resend timer
    const resendTimeLeft = Math.max(0, Math.floor((resendTime - now) / 1000));
    const resendButton = document.getElementById('resendButton');
    const resendTimer = document.getElementById('resendTimer');
    
    if (resendTimeLeft > 0) {
        resendButton.disabled = true;
        resendTimer.textContent = `(${resendTimeLeft}s)`;
    } else {
        resendButton.disabled = false;
        resendTimer.textContent = '';
    }
    
    // Continue updating if either timer is still running
    if (otpTimeLeft > 0 || resendTimeLeft > 0) {
        requestAnimationFrame(updateTimers);
    }
}

function resendOTP() {
    // Reset timers
    otpExpiryTime = new Date(Date.now() + 5 * 60 * 1000);
    resendTime = new Date(Date.now() + 30 * 1000);
    
    // Store new times in sessionStorage
    sessionStorage.setItem('otpExpiryTime', otpExpiryTime.toISOString());
    sessionStorage.setItem('resendTime', resendTime.toISOString());
    
    // Start updating timers
    updateTimers();
    
    // Make AJAX call to resend OTP
    fetch('{% url "resend_otp" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            user_id: document.querySelector('[name=user_id]').value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-success';
            messageDiv.textContent = 'OTP has been resent to your email';
            document.querySelector('form').insertBefore(messageDiv, document.querySelector('form').firstChild);
            
            // Remove message after 3 seconds
            setTimeout(() => messageDiv.remove(), 3000);
        }
    });
}

function togglePasswordVisibility(inputId) {
    const passwordInput = document.getElementById(inputId);
    const toggleIcon = passwordInput.nextElementSibling.querySelector('i');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.classList.remove('fa-eye');
        toggleIcon.classList.add('fa-eye-slash');
    } else {
        passwordInput.type = 'password';
        toggleIcon.classList.remove('fa-eye-slash');
        toggleIcon.classList.add('fa-eye');
    }
}

// Initialize timers when page loads
document.addEventListener('DOMContentLoaded', initializeTimers);
</script>
{% endblock %}
