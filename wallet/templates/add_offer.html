{% extends "base.html" %}

{% block title %}Add Offer{% endblock %}

{% block style %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.css">

<style>
body {
    font-family: Arial, sans-serif;
    background-color: #1e1e1e;
    color: #ffffff;
    margin: 0;
    padding: 0;
}
.header {
    background-color: #000000;
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: fixed;
    width: 100%;
    z-index: 1000;
}
.sidebar {
    background-color: #1e1e1e;
    height: calc(100vh - 50px);
    width: 250px;
    position: fixed;
    top: 50px;
    left: 0;
    padding-top: 10px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}
.sidebar .nav-link {
    color: #ffffff;
    padding: 10px 15px;
    margin: 2px 10px;
    border-radius: 5px;
    display: flex;
    align-items: center;
    transition: background-color 0.3s ease;
}
.sidebar .nav-link i {
    margin-right: 15px;
    width: 20px;
    font-size: 18px;
}
.sidebar .nav-link:hover, .sidebar .nav-link.active {
    background-color: #2c2c2c;
}
.main-content {
    margin-left: 250px;
    padding: 70px 20px 20px;
}
.sidebar-main-menu {
    flex-grow: 1;
    overflow-y: auto;
}
.sidebar-footer-menu {
    margin-top: auto;
    padding-top: 20px;
    border-top: 1px solid #2c2c2c;
}
.sidebar .nav-item {
    margin-bottom: 0%;
}
.table-dark {
    background-color: #1e1e1e;
}
.table-dark th {
    background-color: #2c2c2c;
}
.form-control, .form-select {
    background-color: #2c2c2c;
    border-color: #444;
    color: white;
}
.form-control:focus, .form-select:focus {
    background-color: #2c2c2c;
    border-color: #666;
    color: white;
    box-shadow: none;
}
.modal-content {
    background-color: #2c2c2c;
    color: #ffffff;
}
.modal-header, .modal-footer {
    border-color: #444;
}
.btn-close {
    filter: invert(1) grayscale(100%) brightness(200%);
}
.card {
    background-color: #2c2c2c;
    border-color: #444;
}
.card-header {
    background-color: #1e1e1e;
    border-bottom-color: #444;
}
body, .form-control, .form-select, .btn, .nav-link, .card-header, .card-body, label, small {
    color: #ffffff !important;
}
.text-muted {
    color: #cccccc !important;
}
.list-group-item {
    background-color: #2c2c2c;
    color: #ffffff;
    border-color: #444;
}
.list-group-item:hover {
    background-color: #3c3c3c;
}
.btn-outline-primary {
    color: #ffffff;
    border-color: #ffffff;
}
.btn-outline-primary:hover {
    background-color: #ffffff;
    color: #1e1e1e !important;
}
</style>
{% endblock %}

{% block body %}
<header class="header">
    <h1 class="m-0">StrideKicks</h1>
    <div class="d-flex align-items-center">
        <span class="me-3">{{ first_name }}</span>
        <i class="fas fa-user-circle fa-lg"></i>
    </div>
</header>

<nav class="sidebar">
    <div class="sidebar-main-menu">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="{% url 'admin_dashboard' %}">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'customers' %}">
                    <i class="fas fa-users"></i>
                    <span>Customers</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'products' %}">
                    <i class="fas fa-box"></i>
                    <span>Products</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'orders' %}">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Orders</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'banner_management' %}">
                    <i class="fas fa-image"></i>
                    <span>Banner Management</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'coupon' %}">
                    <i class="fas fa-ticket-alt"></i>
                    <span>Coupon Management</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="{% url 'offer_management' %}">
                    <i class="fas fa-gift"></i>
                    <span>Offer Management</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'sales_report' %}">
                    <i class="fas fa-chart-line"></i>
                    <span>Sales Report</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'brand' %}">
                    <i class="fas fa-briefcase"></i>
                    <span>Brand</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'category' %}">
                    <i class="fas fa-tags"></i>
                    <span>Category</span>
                </a>
            </li>
        </ul>
    </div>
    <div class="sidebar-footer-menu">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="{% url 'settings' %}">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">
                    <form action="{% url 'logout_account' %}" method="post">
                        {% csrf_token %}
                        <button class="btn btn-outline-primary">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </button>
                    </form>
                </a>
            </li>
        </ul>
    </div>
</nav>

<main class="main-content">
    <div class="container mt-4">
        <div class="card">
            <div class="card-header">
                <h4>Add New Offer</h4>
            </div>
            <div class="card-body">
                <form id="offerForm" method="POST">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="name" class="form-label">Offer Name</label>
                        <input type="text" class="form-control" id="name" name="name">
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="offer_type" class="form-label">Offer Type</label>
                        <select class="form-select" id="offer_type" name="offer_type">
                            <option value="">Select Offer Type</option>
                            <option value="Product">Product Offer</option>
                            <option value="Category">Category Offer</option>
                        </select>
                    </div>

                    <!-- Product Search - Initially Hidden -->
                    <div id="productSection" class="mb-3" style="display: none;">
                        <label for="productSearch" class="form-label">Search Product</label>
                        <input type="text" class="form-control" id="productSearch" placeholder="Search for products...">
                        <input type="hidden" id="product" name="product">
                        <div id="productResults" class="list-group mt-2"></div>
                    </div>

                    <!-- Category Search - Initially Hidden -->
                    <div id="categorySection" class="mb-3" style="display: none;">
                        <label for="categorySearch" class="form-label">Search Category</label>
                        <input type="text" class="form-control" id="categorySearch" placeholder="Search for categories...">
                        <input type="hidden" id="category" name="category">
                        <div id="categoryResults" class="list-group mt-2"></div>
                    </div>

                    <div class="mb-3">
                        <label for="discount_percentage" class="form-label">Discount Percentage</label>
                        <input type="number" class="form-control" id="discount_percentage" name="discount_percentage">
                        <small class="text-muted">Enter a value between 1 and 90</small>
                    </div>

                    <div class="mb-3">
                        <label for="start_date" class="form-label">Start Date</label>
                        <input type="datetime-local" class="form-control" id="start_date" name="start_date">
                    </div>

                    <div class="mb-3">
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="datetime-local" class="form-control" id="end_date" name="end_date">
                    </div>

                    <button type="submit" class="btn btn-primary">Add Offer</button>
                    <a href="{% url 'offer_management' %}" class="btn btn-secondary">Cancel</a>
                </form>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const offerType = document.getElementById('offer_type');
        const productSection = document.getElementById('productSection');
        const categorySection = document.getElementById('categorySection');
        const productSearch = document.getElementById('productSearch');
        const categorySearch = document.getElementById('categorySearch');
        const productResults = document.getElementById('productResults');
        const categoryResults = document.getElementById('categoryResults');
        const offerForm = document.getElementById('offerForm');

        // Handle offer type change
        offerType.addEventListener('change', function() {
            if (this.value === 'Product') {
                productSection.style.display = 'block';
                categorySection.style.display = 'none';
                document.getElementById('category').value = '';
                categorySearch.value = '';
            } else if (this.value === 'Category') {
                productSection.style.display = 'none';
                categorySection.style.display = 'block';
                document.getElementById('product').value = '';
                productSearch.value = '';
            } else {
                productSection.style.display = 'none';
                categorySection.style.display = 'none';
                document.getElementById('product').value = '';
                document.getElementById('category').value = '';
                productSearch.value = '';
                categorySearch.value = '';
            }
        });

        // Search functionality for products
        let productSearchTimeout;
        productSearch.addEventListener('input', function() {
            clearTimeout(productSearchTimeout);
            productSearchTimeout = setTimeout(() => {
                const query = this.value.trim();
                if (query.length >= 1) {
                    fetch(`/wallet/search-items/?q=${encodeURIComponent(query)}&type=product`)
                        .then(response => response.json())
                        .then(data => {
                            productResults.innerHTML = '';
                            if (data.results.length === 0) {
                                const div = document.createElement('div');
                                div.className = 'list-group-item';
                                div.textContent = 'No products found';
                                productResults.appendChild(div);
                            } else {
                                data.results.forEach(item => {
                                    const a = document.createElement('a');
                                    a.href = '#';
                                    a.className = 'list-group-item list-group-item-action';
                                    a.textContent = item.name;
                                    a.onclick = function(e) {
                                        e.preventDefault();
                                        document.getElementById('product').value = item.id;
                                        productSearch.value = item.name;
                                        productResults.innerHTML = '';
                                    };
                                    productResults.appendChild(a);
                                });
                            }
                        });
                } else {
                    productResults.innerHTML = '';
                }
            }, 300);
        });

        // Search functionality for categories
        let categorySearchTimeout;
        categorySearch.addEventListener('input', function() {
            clearTimeout(categorySearchTimeout);
            categorySearchTimeout = setTimeout(() => {
                const query = this.value.trim();
                if (query.length >= 1) {
                    fetch(`/wallet/search-items/?q=${encodeURIComponent(query)}&type=category`)
                        .then(response => response.json())
                        .then(data => {
                            categoryResults.innerHTML = '';
                            if (data.results.length === 0) {
                                const div = document.createElement('div');
                                div.className = 'list-group-item';
                                div.textContent = 'No categories found';
                                categoryResults.appendChild(div);
                            } else {
                                data.results.forEach(item => {
                                    const a = document.createElement('a');
                                    a.href = '#';
                                    a.className = 'list-group-item list-group-item-action';
                                    a.textContent = item.name;
                                    a.onclick = function(e) {
                                        e.preventDefault();
                                        document.getElementById('category').value = item.id;
                                        categorySearch.value = item.name;
                                        categoryResults.innerHTML = '';
                                    };
                                    categoryResults.appendChild(a);
                                });
                            }
                        });
                } else {
                    categoryResults.innerHTML = '';
                }
            }, 300);
        });

        // Form submission with validation
        offerForm.addEventListener('submit', function(e) {
            e.preventDefault();

            // Validate required fields
            const name = document.getElementById('name').value.trim();
            const description = document.getElementById('description').value.trim();
            const selectedType = offerType.value;
            const discount = document.getElementById('discount_percentage').value;
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;

            if (!name) {
                Toastify({
                    text: "Please enter an offer name",
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    style: {
                        background: "#dc3545"
                    }
                }).showToast();
                return;
            }

            if (!description) {
                Toastify({
                    text: "Please enter a description",
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    style: {
                        background: "#dc3545"
                    }
                }).showToast();
                return;
            }

            if (!selectedType) {
                Toastify({
                    text: "Please select an offer type",
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    style: {
                        background: "#dc3545"
                    }
                }).showToast();
                return;
            }

            if (selectedType === 'Product' && !document.getElementById('product').value) {
                Toastify({
                    text: "Please select a product",
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    style: {
                        background: "#dc3545"
                    }
                }).showToast();
                return;
            }

            if (selectedType === 'Category' && !document.getElementById('category').value) {
                Toastify({
                    text: "Please select a category",
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    style: {
                        background: "#dc3545"
                    }
                }).showToast();
                return;
            }

            if (!discount || discount < 1 || discount > 90) {
                Toastify({
                    text: "Please enter a valid discount percentage between 1 and 90",
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    style: {
                        background: "#dc3545"
                    }
                }).showToast();
                return;
            }

            if (!startDate) {
                Toastify({
                    text: "Please select a start date",
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    style: {
                        background: "#dc3545"
                    }
                }).showToast();
                return;
            }

            if (!endDate) {
                Toastify({
                    text: "Please select an end date",
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    style: {
                        background: "#dc3545"
                    }
                }).showToast();
                return;
            }

            const formData = new FormData(this);

            fetch('{% url "add_offer" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Toastify({
                        text: data.message,
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        style: {
                            background: "#28a745"
                        }
                    }).showToast();
                    window.location.href = '{% url "offer_management" %}';
                } else {
                    Toastify({
                        text: data.message,
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        style: {
                            background: "#dc3545"
                        }
                    }).showToast();
                }
            })
            .catch(error => {
                Toastify({
                    text: "An error occurred. Please try again.",
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    style: {
                        background: "#dc3545"
                    }
                }).showToast();
            });
        });

        // Sidebar navigation active state
        const navLinks = document.querySelectorAll('.sidebar .nav-link');
        navLinks.forEach(link => {
            link.addEventListener('click', function() {
                navLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            });
        });
    });
</script>
{% endblock %}
